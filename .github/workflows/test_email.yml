name: Test Email

on:
  # 只允許手動觸發
  workflow_dispatch:
    inputs:
      test_mode:
        description: '測試模式 (fetch_and_send: 抓取並發送, send_only: 僅發送測試郵件)'
        required: true
        default: 'fetch_and_send'
        type: choice
        options:
          - 'fetch_and_send'
          - 'send_only'

jobs:
  test-email:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Fetch articles (if fetch_and_send mode)
        if: ${{ github.event.inputs.test_mode == 'fetch_and_send' }}
        env:
          NCBI_API_KEY: ${{ secrets.NCBI_API_KEY }}
        run: |
          python fetch_weekly.py --days-back 7 --max-results 30

      - name: Create test data (if send_only mode)
        if: ${{ github.event.inputs.test_mode == 'send_only' }}
        run: |
          mkdir -p data
          cat > data/weekly_summary.json << 'EOF'
          {
            "報告日期": "2025-01-31T12:00:00",
            "執行摘要": {
              "總文章數": 25,
              "高影響力期刊文章數": 5,
              "主要發現": [
                "本週熱門研究主題: SGLT2 inhibitor (8篇), biomarker (6篇)",
                "高影響力期刊發表 5 篇，包括: NEJM, Kidney Int",
                "高品質證據: 3 篇 RCT, 2 篇統合分析"
              ]
            },
            "分類統計": {
              "兒童腎臟學": {"文章數": 10},
              "成人腎臟學": {"文章數": 15}
            },
            "研究趨勢": {
              "熱門主題": [
                ["SGLT2 inhibitor", 8],
                ["biomarker", 6],
                ["machine learning", 4],
                ["cardiovascular", 3]
              ]
            },
            "重點文章": [
              {
                "標題": "Effect of SGLT2 Inhibitors on Kidney Outcomes in Patients with CKD: A Randomized Controlled Trial",
                "期刊": "New England Journal of Medicine",
                "研究類型": "隨機對照試驗",
                "發表日期": "2025 Jan",
                "是否高影響力期刊": true,
                "PubMed連結": "https://pubmed.ncbi.nlm.nih.gov/12345678/",
                "PICO": {
                  "P_族群": "4,304 位患有第 3-4 期慢性腎臟病且 eGFR 25-75 mL/min/1.73m² 的成年患者",
                  "I_介入": "Dapagliflozin 10 mg 每日一次口服",
                  "C_對照": "安慰劑對照組",
                  "O_結果": "複合腎臟終點（eGFR 持續下降 ≥50%、末期腎病、腎臟或心血管死亡）"
                },
                "中文摘要": "【研究目的】本隨機對照試驗旨在評估 SGLT2 抑制劑 dapagliflozin 對慢性腎臟病患者腎臟預後的影響。\n\n【研究方法】採用多中心、雙盲、安慰劑對照設計，納入 4,304 位 CKD 患者，隨機分配至 dapagliflozin 10mg 或安慰劑組，追蹤中位數 2.4 年。\n\n【主要結果】Dapagliflozin 組的主要複合終點發生率為 9.2%，安慰劑組為 14.5%（HR 0.61, 95% CI 0.51-0.72, P<0.001），風險降低 39%。\n\n【結論】SGLT2 抑制劑顯著降低 CKD 患者的腎臟疾病進展風險，應考慮納入 CKD 標準治療。"
              },
              {
                "標題": "Novel Urinary Biomarkers for Early Detection of Acute Kidney Injury in Critically Ill Children",
                "期刊": "Pediatric Nephrology",
                "研究類型": "前瞻性世代研究",
                "發表日期": "2025 Jan",
                "是否高影響力期刊": true,
                "PubMed連結": "https://pubmed.ncbi.nlm.nih.gov/12345679/",
                "PICO": {
                  "P_族群": "523 位入住兒童加護病房的危重症兒童（年齡 1 個月至 18 歲）",
                  "I_介入": "尿液 NGAL、KIM-1、IL-18 等新型生物標記檢測",
                  "C_對照": "傳統血清肌酸酐檢測",
                  "O_結果": "AKI 早期診斷的敏感度、特異度及 AUC"
                },
                "中文摘要": "【研究目的】本前瞻性世代研究旨在評估新型尿液生物標記在兒童急性腎損傷早期診斷中的價值。\n\n【研究方法】連續收錄 523 位 PICU 病童，於入院後 6、12、24 小時收集尿液檢測 NGAL、KIM-1、IL-18，並與血清肌酸酐比較。\n\n【主要結果】尿液 NGAL 在 AKI 發生前 12-24 小時即顯著升高，AUC 達 0.89，優於血清肌酸酐（AUC 0.72）。組合三種標記可將 AUC 提升至 0.93。\n\n【結論】新型尿液生物標記可早期預測兒童 AKI，有助於及時介入治療，改善預後。"
              }
            ],
            "研究想法": [
              {
                "類型": "熱門主題延伸",
                "關鍵詞": "SGLT2 inhibitor",
                "想法": "目前 'SGLT2 inhibitor' 是研究熱點，可考慮在本地族群中驗證相關發現",
                "建議研究類型": "觀察性研究"
              }
            ]
          }
          EOF

      - name: Generate HTML report
        run: |
          python -c "
          from email_report import generate_html_report, save_html_report
          html = generate_html_report()
          save_html_report(html, 'data/weekly_report.html')
          print('HTML report generated successfully')
          "

      - name: Read summary
        id: summary
        run: |
          TOTAL=$(python -c "import json; d=json.load(open('data/weekly_summary.json')); print(d.get('執行摘要', {}).get('總文章數', 0))")
          HIGH_IMPACT=$(python -c "import json; d=json.load(open('data/weekly_summary.json')); print(d.get('執行摘要', {}).get('高影響力期刊文章數', 0))")
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "high_impact=$HIGH_IMPACT" >> $GITHUB_OUTPUT

      - name: Send test email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "[測試] 腎臟學研究週報 - ${{ steps.summary.outputs.total }} 篇文章"
          to: ${{ secrets.EMAIL_TO }}
          from: "腎臟學研究週報 <${{ secrets.EMAIL_USERNAME }}>"
          html_body: file://data/weekly_report.html
          attachments: data/weekly_summary.json

      - name: Success message
        run: |
          echo "## 測試 Email 發送成功！" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- 模式: ${{ github.event.inputs.test_mode }}" >> $GITHUB_STEP_SUMMARY
          echo "- 總文章數: ${{ steps.summary.outputs.total }}" >> $GITHUB_STEP_SUMMARY
          echo "- 高影響力期刊: ${{ steps.summary.outputs.high_impact }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "請檢查您的郵箱是否收到測試郵件。" >> $GITHUB_STEP_SUMMARY
